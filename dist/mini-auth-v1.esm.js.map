{"version":3,"file":"mini-auth-v1.esm.js","sources":["../src/lib/index.js"],"sourcesContent":["import { miniAuth } from 'miniapp-auth';\nimport { defaultSign } from 'mksign';\n\nexport const MODULE_NAME = 'mini-auth-v1';\n\nlet auth = null;\n\nexport function creatMiniAuth({\n  appid, env, url, appKey, appSecret, headers,\n} = { env: 'weapp' }) {\n  if (auth) {\n    return auth;\n  }\n\n  auth = miniAuth.create({\n    appid,\n    env,\n    headers,\n    tokenReqConfig: {\n      url,\n      method: 'POST',\n    },\n  });\n\n  auth.use('token', (ctx, next) => {\n    const { jsCode } = ctx.tokenReqData;\n    if (jsCode) {\n      if (typeof wx !== 'undefined' && wx) {\n        ctx.tokenReqData = {\n          js_code: jsCode,\n          sign: defaultSign({\n            js_code: jsCode,\n            app_key: appKey,\n          }, [appSecret]),\n          app_key: appKey,\n        };\n      }\n      if (typeof my !== 'undefined' && my) {\n        ctx.tokenReqData = {\n          auth_code: jsCode,\n          sign: defaultSign({\n            auth_code: jsCode,\n            app_key: appKey,\n          }, [appSecret]),\n          app_key: appKey,\n        };\n      }\n    }\n    next();\n  });\n  auth.use('afterToken', (ctx, next) => {\n    const { data = {}, retcode, msg } = ctx.tokenResData.data;\n    if (retcode === 200) {\n      ctx.tokenResData = data;\n      return next();\n    }\n    return next({\n      retcode,\n      msg,\n      data,\n    });\n  });\n\n  return auth;\n}\n\nexport function getToken(opts = {}) {\n  const maxRetry = 3;\n\n  return new Promise((resolve, reject) => {\n    function selfGetToken(retry) {\n      auth\n        .getToken(opts)\n        .then(res => {\n          resolve(res);\n        })\n        .catch(err => {\n          if (err.errCode === 5001 || err.errCode === 5002) {\n            if (retry >= maxRetry) {\n              reject(err);\n            } else {\n              setTimeout(() => {\n                selfGetToken(retry + 1);\n              }, 2000);\n            }\n          } else {\n            reject(err);\n          }\n        });\n    }\n    selfGetToken(0);\n  });\n}\n"],"names":["auth","creatMiniAuth","env","appid","url","appKey","appSecret","headers","miniAuth","create","tokenReqConfig","method","use","ctx","next","jsCode","tokenReqData","wx","js_code","sign","defaultSign","app_key","my","auth_code","tokenResData","data","retcode","msg","getToken","opts","Promise","resolve","reject","selfGetToken","retry","then","res","err","errCode","setTimeout"],"mappings":";;;AAKA,IAAIA,IAAI,CAAG,IAAX,CAEA,SAAgBC,aAAT,EAEe,iEAAlB,CAAEC,GAAG,CAAE,OAAP,CAAkB,CADpBC,KACoB,MADpBA,KACoB,CADbD,GACa,MADbA,GACa,CADRE,GACQ,MADRA,GACQ,CADHC,MACG,MADHA,MACG,CADKC,SACL,MADKA,SACL,CADgBC,OAChB,MADgBA,OAChB,QAChBP,IADgB,CAEXA,IAFW,EAKpBA,IAAI,CAAGQ,QAAQ,CAACC,MAAT,CAAgB,CACrBN,KAAK,CAALA,KADqB,CAErBD,GAAG,CAAHA,GAFqB,CAGrBK,OAAO,CAAPA,OAHqB,CAIrBG,cAAc,CAAE,CACdN,GAAG,CAAHA,GADc,CAEdO,MAAM,CAAE,MAFM,CAJK,CAAhB,CALa,CAepBX,IAAI,CAACY,GAAL,CAAS,OAAT,CAAkB,SAACC,GAAD,CAAMC,IAAN,CAAe,KACvBC,MADuB,CACZF,GAAG,CAACG,YADQ,CACvBD,MADuB,CAE3BA,MAF2B,GAGX,WAAd,SAAOE,EAAP,EAA6BA,EAHJ,GAI3BJ,GAAG,CAACG,YAAJ,CAAmB,CACjBE,OAAO,CAAEH,MADQ,CAEjBI,IAAI,CAAEC,WAAW,CAAC,CAChBF,OAAO,CAAEH,MADO,CAEhBM,OAAO,CAAEhB,MAFO,CAAD,CAGd,CAACC,SAAD,CAHc,CAFA,CAMjBe,OAAO,CAAEhB,MANQ,CAJQ,EAaX,WAAd,SAAOiB,EAAP,EAA6BA,EAbJ,GAc3BT,GAAG,CAACG,YAAJ,CAAmB,CACjBO,SAAS,CAAER,MADM,CAEjBI,IAAI,CAAEC,WAAW,CAAC,CAChBG,SAAS,CAAER,MADK,CAEhBM,OAAO,CAAEhB,MAFO,CAAD,CAGd,CAACC,SAAD,CAHc,CAFA,CAMjBe,OAAO,CAAEhB,MANQ,CAdQ,GAwB/BS,IAAI,GACL,CAzBD,CAfoB,CAyCpBd,IAAI,CAACY,GAAL,CAAS,YAAT,CAAuB,SAACC,GAAD,CAAMC,IAAN,CAAe,2BACAD,GAAG,CAACW,YAAJ,CAAiBC,IADjB,8CAC5BA,IAD4B,CAC5BA,IAD4B,iCACrB,EADqB,wBACjBC,OADiB,uBACjBA,OADiB,CACRC,GADQ,uBACRA,GADQ,WAEhC,GAAAD,OAFgC,EAGlCb,GAAG,CAACW,YAAJ,CAAmBC,IAHe,CAI3BX,IAAI,EAJuB,EAM7BA,IAAI,CAAC,CACVY,OAAO,CAAPA,OADU,CAEVC,GAAG,CAAHA,GAFU,CAGVF,IAAI,CAAJA,IAHU,CAAD,CAKZ,CAXD,CAzCoB,CAsDbzB,IAtDa,CAuDrB,CAED,SAAgB4B,QAAT,EAA6B,KAAXC,IAAW,wDAAJ,EAAI,CAGlC,WAAWC,OAAJ,CAAY,SAACC,OAAD,CAAUC,MAAV,CAAqB,CACtC,SAASC,YAAT,CAAsBC,KAAtB,CAA6B,CAC3BlC,IAAI,CACD4B,QADH,CACYC,IADZ,EAEGM,IAFH,CAEQ,SAAAC,GAAG,CAAI,CACXL,OAAO,CAACK,GAAD,EACR,CAJH,WAKS,SAAAC,GAAG,CAAI,CACQ,IAAhB,GAAAA,GAAG,CAACC,OAAJ,EAAwC,IAAhB,GAAAD,GAAG,CAACC,OADpB,CAENJ,KAAK,EAXF,CASG,CAGRF,MAAM,CAACK,GAAD,CAHE,CAKRE,UAAU,CAAC,UAAM,CACfN,YAAY,CAACC,KAAK,CAAG,CAAT,EACb,CAFS,CAEP,GAFO,CALF,CAUVF,MAAM,CAACK,GAAD,EAET,CAjBH,EAkBD,CACDJ,YAAY,CAAC,CAAD,EACb,CAtBM,CAuBR;;;;"}