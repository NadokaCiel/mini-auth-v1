!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("promise"),require("miniapp-auth")):"function"==typeof define&&define.amd?define(["exports","promise","miniapp-auth"],e):(t=t||self,function(){var n=t["mini-auth-v1"],r=t["mini-auth-v1"]={};e(r,t.Promise,t.miniappAuth),r.noConflict=function(){return t["mini-auth-v1"]=n,r}}())}(this,(function(t,e,n){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e;var r=i;function i(t,e){if(!t)throw new Error(e||"Assertion failed")}function o(t,e){return t(e={exports:{}},e.exports),e.exports}i.equal=function(t,e,n){if(t!=e)throw new Error(n||"Assertion failed: "+t+" != "+e)},global.setTimeout,global.clearTimeout;var u=global.performance||{},s=(u.now||u.mozNow||u.msNow||u.oNow||u.webkitNow,"function"==typeof Object.create?function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:function(t,e){t.super_=e;var n=function(){};n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t}),c=/%[sdj%]/g;function a(t){if(!S(t)){for(var e=[],n=0;n<arguments.length;n++)e.push(h(arguments[n]));return e.join(" ")}n=1;for(var r=arguments,i=r.length,o=String(t).replace(c,(function(t){if("%%"===t)return"%";if(n>=i)return t;switch(t){case"%s":return String(r[n++]);case"%d":return Number(r[n++]);case"%j":try{return JSON.stringify(r[n++])}catch(t){return"[Circular]"}default:return t}})),u=r[n];n<i;u=r[++n])_(u)||!z(u)?o+=" "+u:o+=" "+h(u);return o}var l,f={};function h(t,e){var n={seen:[],stylize:g};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),b(e)?n.showHidden=e:e&&R(n,e),j(n.showHidden)&&(n.showHidden=!1),j(n.depth)&&(n.depth=2),j(n.colors)&&(n.colors=!1),j(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=p),d(n,t,n.depth)}function p(t,e){var n=h.styles[e];return n?"["+h.colors[n][0]+"m"+t+"["+h.colors[n][1]+"m":t}function g(t,e){return t}function d(t,e,n){if(t.customInspect&&e&&A(e.inspect)&&e.inspect!==h&&(!e.constructor||e.constructor.prototype!==e)){var r=e.inspect(n,t);return S(r)||(r=d(t,r,n)),r}var i=function(t,e){if(j(e))return t.stylize("undefined","undefined");if(S(e)){var n="'"+JSON.stringify(e).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return t.stylize(n,"string")}if(w(e))return t.stylize(""+e,"number");if(b(e))return t.stylize(""+e,"boolean");if(_(e))return t.stylize("null","null")}(t,e);if(i)return i;var o=Object.keys(e),u=function(t){var e={};return t.forEach((function(t,n){e[t]=!0})),e}(o);if(t.showHidden&&(o=Object.getOwnPropertyNames(e)),k(e)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return y(e);if(0===o.length){if(A(e)){var s=e.name?": "+e.name:"";return t.stylize("[Function"+s+"]","special")}if(x(e))return t.stylize(RegExp.prototype.toString.call(e),"regexp");if(O(e))return t.stylize(Date.prototype.toString.call(e),"date");if(k(e))return y(e)}var c,a="",l=!1,f=["{","}"];(m(e)&&(l=!0,f=["[","]"]),A(e))&&(a=" [Function"+(e.name?": "+e.name:"")+"]");return x(e)&&(a=" "+RegExp.prototype.toString.call(e)),O(e)&&(a=" "+Date.prototype.toUTCString.call(e)),k(e)&&(a=" "+y(e)),0!==o.length||l&&0!=e.length?n<0?x(e)?t.stylize(RegExp.prototype.toString.call(e),"regexp"):t.stylize("[Object]","special"):(t.seen.push(e),c=l?function(t,e,n,r,i){for(var o=[],u=0,s=e.length;u<s;++u)T(e,String(u))?o.push(v(t,e,n,r,String(u),!0)):o.push("");return i.forEach((function(i){i.match(/^\d+$/)||o.push(v(t,e,n,r,i,!0))})),o}(t,e,n,u,o):o.map((function(r){return v(t,e,n,u,r,l)})),t.seen.pop(),function(t,e,n){if(t.reduce((function(t,e){return e.indexOf("\n"),t+e.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60)return n[0]+(""===e?"":e+"\n ")+" "+t.join(",\n  ")+" "+n[1];return n[0]+e+" "+t.join(", ")+" "+n[1]}(c,a,f)):f[0]+a+f[1]}function y(t){return"["+Error.prototype.toString.call(t)+"]"}function v(t,e,n,r,i,o){var u,s,c;if((c=Object.getOwnPropertyDescriptor(e,i)||{value:e[i]}).get?s=c.set?t.stylize("[Getter/Setter]","special"):t.stylize("[Getter]","special"):c.set&&(s=t.stylize("[Setter]","special")),T(r,i)||(u="["+i+"]"),s||(t.seen.indexOf(c.value)<0?(s=_(n)?d(t,c.value,null):d(t,c.value,n-1)).indexOf("\n")>-1&&(s=o?s.split("\n").map((function(t){return"  "+t})).join("\n").substr(2):"\n"+s.split("\n").map((function(t){return"   "+t})).join("\n")):s=t.stylize("[Circular]","special")),j(u)){if(o&&i.match(/^\d+$/))return s;(u=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(u=u.substr(1,u.length-2),u=t.stylize(u,"name")):(u=u.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),u=t.stylize(u,"string"))}return u+": "+s}function m(t){return Array.isArray(t)}function b(t){return"boolean"==typeof t}function _(t){return null===t}function w(t){return"number"==typeof t}function S(t){return"string"==typeof t}function j(t){return void 0===t}function x(t){return z(t)&&"[object RegExp]"===C(t)}function z(t){return"object"==typeof t&&null!==t}function O(t){return z(t)&&"[object Date]"===C(t)}function k(t){return z(t)&&("[object Error]"===C(t)||t instanceof Error)}function A(t){return"function"==typeof t}function C(t){return Object.prototype.toString.call(t)}function D(t){return t<10?"0"+t.toString(10):t.toString(10)}h.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},h.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};var E=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function N(){var t=new Date,e=[D(t.getHours()),D(t.getMinutes()),D(t.getSeconds())].join(":");return[t.getDate(),E[t.getMonth()],e].join(" ")}function R(t,e){if(!e||!z(e))return t;for(var n=Object.keys(e),r=n.length;r--;)t[n[r]]=e[n[r]];return t}function T(t,e){return Object.prototype.hasOwnProperty.call(t,e)}var H={inherits:s,_extend:R,log:function(){console.log("%s - %s",N(),a.apply(null,arguments))},isBuffer:function(t){return Buffer.isBuffer(t)},isPrimitive:function(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||"symbol"==typeof t||void 0===t},isFunction:A,isError:k,isDate:O,isObject:z,isRegExp:x,isUndefined:j,isSymbol:function(t){return"symbol"==typeof t},isString:S,isNumber:w,isNullOrUndefined:function(t){return null==t},isNull:_,isBoolean:b,isArray:m,inspect:h,deprecate:function t(e,n){if(j(global.process))return function(){return t(e,n).apply(this,arguments)};var r=!1;return function(){return r||(console.error(n),r=!0),e.apply(this,arguments)}},format:a,debuglog:function(t){if(j(l)&&(l=""),t=t.toUpperCase(),!f[t])if(new RegExp("\\b"+t+"\\b","i").test(l)){f[t]=function(){var e=a.apply(null,arguments);console.error("%s %d: %s",t,0,e)}}else f[t]=function(){};return f[t]}},q=o((function(t){"function"==typeof Object.create?t.exports=function(t,e){e&&(t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(t,e){if(e){t.super_=e;var n=function(){};n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t}}}));function P(t,e){return 55296==(64512&t.charCodeAt(e))&&(!(e<0||e+1>=t.length)&&56320==(64512&t.charCodeAt(e+1)))}function J(t){return(t>>>24|t>>>8&65280|t<<8&16711680|(255&t)<<24)>>>0}function L(t){return 1===t.length?"0"+t:t}function B(t){return 7===t.length?"0"+t:6===t.length?"00"+t:5===t.length?"000"+t:4===t.length?"0000"+t:3===t.length?"00000"+t:2===t.length?"000000"+t:1===t.length?"0000000"+t:t}var M={inherits:o((function(t){try{var e=H;if("function"!=typeof e.inherits)throw"";t.exports=e.inherits}catch(e){t.exports=q}})),toArray:function(t,e){if(Array.isArray(t))return t.slice();if(!t)return[];var n=[];if("string"==typeof t)if(e){if("hex"===e)for((t=t.replace(/[^a-z0-9]+/gi,"")).length%2!=0&&(t="0"+t),i=0;i<t.length;i+=2)n.push(parseInt(t[i]+t[i+1],16))}else for(var r=0,i=0;i<t.length;i++){var o=t.charCodeAt(i);o<128?n[r++]=o:o<2048?(n[r++]=o>>6|192,n[r++]=63&o|128):P(t,i)?(o=65536+((1023&o)<<10)+(1023&t.charCodeAt(++i)),n[r++]=o>>18|240,n[r++]=o>>12&63|128,n[r++]=o>>6&63|128,n[r++]=63&o|128):(n[r++]=o>>12|224,n[r++]=o>>6&63|128,n[r++]=63&o|128)}else for(i=0;i<t.length;i++)n[i]=0|t[i];return n},toHex:function(t){for(var e="",n=0;n<t.length;n++)e+=L(t[n].toString(16));return e},htonl:J,toHex32:function(t,e){for(var n="",r=0;r<t.length;r++){var i=t[r];"little"===e&&(i=J(i)),n+=B(i.toString(16))}return n},zero2:L,zero8:B,join32:function(t,e,n,i){var o=n-e;r(o%4==0);for(var u=new Array(o/4),s=0,c=e;s<u.length;s++,c+=4){var a;a="big"===i?t[c]<<24|t[c+1]<<16|t[c+2]<<8|t[c+3]:t[c+3]<<24|t[c+2]<<16|t[c+1]<<8|t[c],u[s]=a>>>0}return u},split32:function(t,e){for(var n=new Array(4*t.length),r=0,i=0;r<t.length;r++,i+=4){var o=t[r];"big"===e?(n[i]=o>>>24,n[i+1]=o>>>16&255,n[i+2]=o>>>8&255,n[i+3]=255&o):(n[i+3]=o>>>24,n[i+2]=o>>>16&255,n[i+1]=o>>>8&255,n[i]=255&o)}return n},rotr32:function(t,e){return t>>>e|t<<32-e},rotl32:function(t,e){return t<<e|t>>>32-e},sum32:function(t,e){return t+e>>>0},sum32_3:function(t,e,n){return t+e+n>>>0},sum32_4:function(t,e,n,r){return t+e+n+r>>>0},sum32_5:function(t,e,n,r,i){return t+e+n+r+i>>>0},sum64:function(t,e,n,r){var i=t[e],o=r+t[e+1]>>>0,u=(o<r?1:0)+n+i;t[e]=u>>>0,t[e+1]=o},sum64_hi:function(t,e,n,r){return(e+r>>>0<e?1:0)+t+n>>>0},sum64_lo:function(t,e,n,r){return e+r>>>0},sum64_4_hi:function(t,e,n,r,i,o,u,s){var c=0,a=e;return c+=(a=a+r>>>0)<e?1:0,c+=(a=a+o>>>0)<o?1:0,t+n+i+u+(c+=(a=a+s>>>0)<s?1:0)>>>0},sum64_4_lo:function(t,e,n,r,i,o,u,s){return e+r+o+s>>>0},sum64_5_hi:function(t,e,n,r,i,o,u,s,c,a){var l=0,f=e;return l+=(f=f+r>>>0)<e?1:0,l+=(f=f+o>>>0)<o?1:0,l+=(f=f+s>>>0)<s?1:0,t+n+i+u+c+(l+=(f=f+a>>>0)<a?1:0)>>>0},sum64_5_lo:function(t,e,n,r,i,o,u,s,c,a){return e+r+o+s+a>>>0},rotr64_hi:function(t,e,n){return(e<<32-n|t>>>n)>>>0},rotr64_lo:function(t,e,n){return(t<<32-n|e>>>n)>>>0},shr64_hi:function(t,e,n){return t>>>n},shr64_lo:function(t,e,n){return(t<<32-n|e>>>n)>>>0}};function $(){this.pending=null,this.pendingTotal=0,this.blockSize=this.constructor.blockSize,this.outSize=this.constructor.outSize,this.hmacStrength=this.constructor.hmacStrength,this.padLength=this.constructor.padLength/8,this.endian="big",this._delta8=this.blockSize/8,this._delta32=this.blockSize/32}var F=$;$.prototype.update=function(t,e){if(t=M.toArray(t,e),this.pending?this.pending=this.pending.concat(t):this.pending=t,this.pendingTotal+=t.length,this.pending.length>=this._delta8){var n=(t=this.pending).length%this._delta8;this.pending=t.slice(t.length-n,t.length),0===this.pending.length&&(this.pending=null),t=M.join32(t,0,t.length-n,this.endian);for(var r=0;r<t.length;r+=this._delta32)this._update(t,r,r+this._delta32)}return this},$.prototype.digest=function(t){return this.update(this._pad()),r(null===this.pending),this._digest(t)},$.prototype._pad=function(){var t=this.pendingTotal,e=this._delta8,n=e-(t+this.padLength)%e,r=new Array(n+this.padLength);r[0]=128;for(var i=1;i<n;i++)r[i]=0;if(t<<=3,"big"===this.endian){for(var o=8;o<this.padLength;o++)r[i++]=0;r[i++]=0,r[i++]=0,r[i++]=0,r[i++]=0,r[i++]=t>>>24&255,r[i++]=t>>>16&255,r[i++]=t>>>8&255,r[i++]=255&t}else for(r[i++]=255&t,r[i++]=t>>>8&255,r[i++]=t>>>16&255,r[i++]=t>>>24&255,r[i++]=0,r[i++]=0,r[i++]=0,r[i++]=0,o=8;o<this.padLength;o++)r[i++]=0;return r};var I={BlockHash:F},U=M.rotr32;function G(t,e,n){return t&e^~t&n}function W(t,e,n){return t&e^t&n^e&n}function Z(t,e,n){return t^e^n}var K={ft_1:function(t,e,n,r){return 0===t?G(e,n,r):1===t||3===t?Z(e,n,r):2===t?W(e,n,r):void 0},ch32:G,maj32:W,p32:Z,s0_256:function(t){return U(t,2)^U(t,13)^U(t,22)},s1_256:function(t){return U(t,6)^U(t,11)^U(t,25)},g0_256:function(t){return U(t,7)^U(t,18)^t>>>3},g1_256:function(t){return U(t,17)^U(t,19)^t>>>10}},Q=M.sum32,V=M.sum32_4,X=M.sum32_5,Y=K.ch32,tt=K.maj32,et=K.s0_256,nt=K.s1_256,rt=K.g0_256,it=K.g1_256,ot=I.BlockHash,ut=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function st(){if(!(this instanceof st))return new st;ot.call(this),this.h=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],this.k=ut,this.W=new Array(64)}M.inherits(st,ot);var ct=st;st.blockSize=512,st.outSize=256,st.hmacStrength=192,st.padLength=64,st.prototype._update=function(t,e){for(var n=this.W,i=0;i<16;i++)n[i]=t[e+i];for(;i<n.length;i++)n[i]=V(it(n[i-2]),n[i-7],rt(n[i-15]),n[i-16]);var o=this.h[0],u=this.h[1],s=this.h[2],c=this.h[3],a=this.h[4],l=this.h[5],f=this.h[6],h=this.h[7];for(r(this.k.length===n.length),i=0;i<n.length;i++){var p=X(h,nt(a),Y(a,l,f),this.k[i],n[i]),g=Q(et(o),tt(o,u,s));h=f,f=l,l=a,a=Q(c,p),c=s,s=u,u=o,o=Q(p,g)}this.h[0]=Q(this.h[0],o),this.h[1]=Q(this.h[1],u),this.h[2]=Q(this.h[2],s),this.h[3]=Q(this.h[3],c),this.h[4]=Q(this.h[4],a),this.h[5]=Q(this.h[5],l),this.h[6]=Q(this.h[6],f),this.h[7]=Q(this.h[7],h)},st.prototype._digest=function(t){return"hex"===t?M.toHex32(this.h,"big"):M.split32(this.h,"big")};var at=null;t.creatMiniAuth=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp"},e=t.appid,r=t.env,i=t.url,o=t.appKey,u=t.appCode,s=t.headers;if(at)return at;var c={url:i,method:"POST",headers:s};return(at=n.miniAuth.create({appid:e,env:r,tokenReqConfig:c})).use("token",(function(t,e){var n=t.tokenReqData.jsCode;n&&("undefined"!=typeof wx&&wx&&(t.tokenReqData={js_code:n}),"undefined"!=typeof my&&my&&(t.tokenReqData={auth_code:n}),c.headers["Authorization-Sign"]=ct().update("".concat(o).concat(JSON.stringify(t.tokenReqData)).concat(u)).digest("hex"),at.setTokenReqConfig("headers",c.headers)),e()})),at.use("afterToken",(function(t,e){var n=t.tokenResData.data,r=n.data,i=void 0===r?{}:r,o=n.retcode,u=n.msg;return 200===o?(t.tokenResData=i,e()):e({retcode:o,msg:u,data:i})})),at},t.getToken=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return new e((function(e,n){!function r(i){at.getToken(t).then((function(t){e(t)})).catch((function(t){5001===t.errCode||5002===t.errCode?i>=3?n(t):setTimeout((function(){r(i+1)}),2e3):n(t)}))}(0)}))},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=mini-auth-v1.common.js.map
