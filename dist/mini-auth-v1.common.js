!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("promise"),require("miniapp-auth")):"function"==typeof define&&define.amd?define(["exports","promise","miniapp-auth"],e):(t="undefined"!=typeof globalThis?globalThis:t||self,function(){var n=t["mini-auth-v1"],r=t["mini-auth-v1"]={};e(r,t.Promise$1,t.miniappAuth),r.noConflict=function(){return t["mini-auth-v1"]=n,r}}())}(this,(function(t,e,n){"use strict";function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=r(e),o=u;function u(t,e){if(!t)throw new Error(e||"Assertion failed")}function s(t,e){return t(e={exports:{}},e.exports),e.exports}u.equal=function(t,e,n){if(t!=e)throw new Error(n||"Assertion failed: "+t+" != "+e)};var a=global.performance||{};a.now||a.mozNow||a.msNow||a.oNow||a.webkitNow;var c="function"==typeof Object.create?function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:function(t,e){t.super_=e;var n=function(){};n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t},h=/%[sdj%]/g;function f(t){if(!x(t)){for(var e=[],n=0;n<arguments.length;n++)e.push(g(arguments[n]));return e.join(" ")}n=1;for(var r=arguments,i=r.length,o=String(t).replace(h,(function(t){if("%%"===t)return"%";if(n>=i)return t;switch(t){case"%s":return String(r[n++]);case"%d":return Number(r[n++]);case"%j":try{return JSON.stringify(r[n++])}catch(t){return"[Circular]"}default:return t}})),u=r[n];n<i;u=r[++n])S(u)||!O(u)?o+=" "+u:o+=" "+g(u);return o}var l,p={};function g(t,e){var n={seen:[],stylize:y};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),w(e)?n.showHidden=e:e&&q(n,e),z(n.showHidden)&&(n.showHidden=!1),z(n.depth)&&(n.depth=2),z(n.colors)&&(n.colors=!1),z(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=d),v(n,t,n.depth)}function d(t,e){var n=g.styles[e];return n?"["+g.colors[n][0]+"m"+t+"["+g.colors[n][1]+"m":t}function y(t,e){return t}function v(t,e,n){if(t.customInspect&&e&&R(e.inspect)&&e.inspect!==g&&(!e.constructor||e.constructor.prototype!==e)){var r=e.inspect(n,t);return x(r)||(r=v(t,r,n)),r}var i=function(t,e){if(z(e))return t.stylize("undefined","undefined");if(x(e)){var n="'"+JSON.stringify(e).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return t.stylize(n,"string")}if(j(e))return t.stylize(""+e,"number");if(w(e))return t.stylize(""+e,"boolean");if(S(e))return t.stylize("null","null")}(t,e);if(i)return i;var o=Object.keys(e),u=function(t){var e={};return t.forEach((function(t,n){e[t]=!0})),e}(o);if(t.showHidden&&(o=Object.getOwnPropertyNames(e)),D(e)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return m(e);if(0===o.length){if(R(e)){var s=e.name?": "+e.name:"";return t.stylize("[Function"+s+"]","special")}if(k(e))return t.stylize(RegExp.prototype.toString.call(e),"regexp");if(A(e))return t.stylize(Date.prototype.toString.call(e),"date");if(D(e))return m(e)}var a,c="",h=!1,f=["{","}"];(_(e)&&(h=!0,f=["[","]"]),R(e))&&(c=" [Function"+(e.name?": "+e.name:"")+"]");return k(e)&&(c=" "+RegExp.prototype.toString.call(e)),A(e)&&(c=" "+Date.prototype.toUTCString.call(e)),D(e)&&(c=" "+m(e)),0!==o.length||h&&0!=e.length?n<0?k(e)?t.stylize(RegExp.prototype.toString.call(e),"regexp"):t.stylize("[Object]","special"):(t.seen.push(e),a=h?function(t,e,n,r,i){for(var o=[],u=0,s=e.length;u<s;++u)H(e,String(u))?o.push(b(t,e,n,r,String(u),!0)):o.push("");return i.forEach((function(i){i.match(/^\d+$/)||o.push(b(t,e,n,r,i,!0))})),o}(t,e,n,u,o):o.map((function(r){return b(t,e,n,u,r,h)})),t.seen.pop(),function(t,e,n){if(t.reduce((function(t,e){return e.indexOf("\n"),t+e.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60)return n[0]+(""===e?"":e+"\n ")+" "+t.join(",\n  ")+" "+n[1];return n[0]+e+" "+t.join(", ")+" "+n[1]}(a,c,f)):f[0]+c+f[1]}function m(t){return"["+Error.prototype.toString.call(t)+"]"}function b(t,e,n,r,i,o){var u,s,a;if((a=Object.getOwnPropertyDescriptor(e,i)||{value:e[i]}).get?s=a.set?t.stylize("[Getter/Setter]","special"):t.stylize("[Getter]","special"):a.set&&(s=t.stylize("[Setter]","special")),H(r,i)||(u="["+i+"]"),s||(t.seen.indexOf(a.value)<0?(s=S(n)?v(t,a.value,null):v(t,a.value,n-1)).indexOf("\n")>-1&&(s=o?s.split("\n").map((function(t){return"  "+t})).join("\n").substr(2):"\n"+s.split("\n").map((function(t){return"   "+t})).join("\n")):s=t.stylize("[Circular]","special")),z(u)){if(o&&i.match(/^\d+$/))return s;(u=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(u=u.substr(1,u.length-2),u=t.stylize(u,"name")):(u=u.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),u=t.stylize(u,"string"))}return u+": "+s}function _(t){return Array.isArray(t)}function w(t){return"boolean"==typeof t}function S(t){return null===t}function j(t){return"number"==typeof t}function x(t){return"string"==typeof t}function z(t){return void 0===t}function k(t){return O(t)&&"[object RegExp]"===N(t)}function O(t){return"object"==typeof t&&null!==t}function A(t){return O(t)&&"[object Date]"===N(t)}function D(t){return O(t)&&("[object Error]"===N(t)||t instanceof Error)}function R(t){return"function"==typeof t}function N(t){return Object.prototype.toString.call(t)}function C(t){return t<10?"0"+t.toString(10):t.toString(10)}g.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},g.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};var E=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function T(){var t=new Date,e=[C(t.getHours()),C(t.getMinutes()),C(t.getSeconds())].join(":");return[t.getDate(),E[t.getMonth()],e].join(" ")}function q(t,e){if(!e||!O(e))return t;for(var n=Object.keys(e),r=n.length;r--;)t[n[r]]=e[n[r]];return t}function H(t,e){return Object.prototype.hasOwnProperty.call(t,e)}var J={inherits:c,_extend:q,log:function(){console.log("%s - %s",T(),f.apply(null,arguments))},isBuffer:function(t){return Buffer.isBuffer(t)},isPrimitive:function(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||"symbol"==typeof t||void 0===t},isFunction:R,isError:D,isDate:A,isObject:O,isRegExp:k,isUndefined:z,isSymbol:function(t){return"symbol"==typeof t},isString:x,isNumber:j,isNullOrUndefined:function(t){return null==t},isNull:S,isBoolean:w,isArray:_,inspect:g,deprecate:function t(e,n){if(z(global.process))return function(){return t(e,n).apply(this,arguments)};var r=!1;return function(){return r||(console.error(n),r=!0),e.apply(this,arguments)}},format:f,debuglog:function(t){if(z(l)&&(l=""),t=t.toUpperCase(),!p[t])if(new RegExp("\\b"+t+"\\b","i").test(l)){p[t]=function(){var e=f.apply(null,arguments);console.error("%s %d: %s",t,0,e)}}else p[t]=function(){};return p[t]}},L=s((function(t){"function"==typeof Object.create?t.exports=function(t,e){e&&(t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}))}:t.exports=function(t,e){if(e){t.super_=e;var n=function(){};n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t}}}));function P(t,e){return 55296==(64512&t.charCodeAt(e))&&(!(e<0||e+1>=t.length)&&56320==(64512&t.charCodeAt(e+1)))}function B(t){return(t>>>24|t>>>8&65280|t<<8&16711680|(255&t)<<24)>>>0}function M(t){return 1===t.length?"0"+t:t}function $(t){return 7===t.length?"0"+t:6===t.length?"00"+t:5===t.length?"000"+t:4===t.length?"0000"+t:3===t.length?"00000"+t:2===t.length?"000000"+t:1===t.length?"0000000"+t:t}var K={inherits:s((function(t){try{var e=J;if("function"!=typeof e.inherits)throw"";t.exports=e.inherits}catch(e){t.exports=L}})),toArray:function(t,e){if(Array.isArray(t))return t.slice();if(!t)return[];var n=[];if("string"==typeof t)if(e){if("hex"===e)for((t=t.replace(/[^a-z0-9]+/gi,"")).length%2!=0&&(t="0"+t),i=0;i<t.length;i+=2)n.push(parseInt(t[i]+t[i+1],16))}else for(var r=0,i=0;i<t.length;i++){var o=t.charCodeAt(i);o<128?n[r++]=o:o<2048?(n[r++]=o>>6|192,n[r++]=63&o|128):P(t,i)?(o=65536+((1023&o)<<10)+(1023&t.charCodeAt(++i)),n[r++]=o>>18|240,n[r++]=o>>12&63|128,n[r++]=o>>6&63|128,n[r++]=63&o|128):(n[r++]=o>>12|224,n[r++]=o>>6&63|128,n[r++]=63&o|128)}else for(i=0;i<t.length;i++)n[i]=0|t[i];return n},toHex:function(t){for(var e="",n=0;n<t.length;n++)e+=M(t[n].toString(16));return e},htonl:B,toHex32:function(t,e){for(var n="",r=0;r<t.length;r++){var i=t[r];"little"===e&&(i=B(i)),n+=$(i.toString(16))}return n},zero2:M,zero8:$,join32:function(t,e,n,r){var i=n-e;o(i%4==0);for(var u=new Array(i/4),s=0,a=e;s<u.length;s++,a+=4){var c;c="big"===r?t[a]<<24|t[a+1]<<16|t[a+2]<<8|t[a+3]:t[a+3]<<24|t[a+2]<<16|t[a+1]<<8|t[a],u[s]=c>>>0}return u},split32:function(t,e){for(var n=new Array(4*t.length),r=0,i=0;r<t.length;r++,i+=4){var o=t[r];"big"===e?(n[i]=o>>>24,n[i+1]=o>>>16&255,n[i+2]=o>>>8&255,n[i+3]=255&o):(n[i+3]=o>>>24,n[i+2]=o>>>16&255,n[i+1]=o>>>8&255,n[i]=255&o)}return n},rotr32:function(t,e){return t>>>e|t<<32-e},rotl32:function(t,e){return t<<e|t>>>32-e},sum32:function(t,e){return t+e>>>0},sum32_3:function(t,e,n){return t+e+n>>>0},sum32_4:function(t,e,n,r){return t+e+n+r>>>0},sum32_5:function(t,e,n,r,i){return t+e+n+r+i>>>0},sum64:function(t,e,n,r){var i=t[e],o=r+t[e+1]>>>0,u=(o<r?1:0)+n+i;t[e]=u>>>0,t[e+1]=o},sum64_hi:function(t,e,n,r){return(e+r>>>0<e?1:0)+t+n>>>0},sum64_lo:function(t,e,n,r){return e+r>>>0},sum64_4_hi:function(t,e,n,r,i,o,u,s){var a=0,c=e;return a+=(c=c+r>>>0)<e?1:0,a+=(c=c+o>>>0)<o?1:0,t+n+i+u+(a+=(c=c+s>>>0)<s?1:0)>>>0},sum64_4_lo:function(t,e,n,r,i,o,u,s){return e+r+o+s>>>0},sum64_5_hi:function(t,e,n,r,i,o,u,s,a,c){var h=0,f=e;return h+=(f=f+r>>>0)<e?1:0,h+=(f=f+o>>>0)<o?1:0,h+=(f=f+s>>>0)<s?1:0,t+n+i+u+a+(h+=(f=f+c>>>0)<c?1:0)>>>0},sum64_5_lo:function(t,e,n,r,i,o,u,s,a,c){return e+r+o+s+c>>>0},rotr64_hi:function(t,e,n){return(e<<32-n|t>>>n)>>>0},rotr64_lo:function(t,e,n){return(t<<32-n|e>>>n)>>>0},shr64_hi:function(t,e,n){return t>>>n},shr64_lo:function(t,e,n){return(t<<32-n|e>>>n)>>>0}};function U(){this.pending=null,this.pendingTotal=0,this.blockSize=this.constructor.blockSize,this.outSize=this.constructor.outSize,this.hmacStrength=this.constructor.hmacStrength,this.padLength=this.constructor.padLength/8,this.endian="big",this._delta8=this.blockSize/8,this._delta32=this.blockSize/32}var F=U;U.prototype.update=function(t,e){if(t=K.toArray(t,e),this.pending?this.pending=this.pending.concat(t):this.pending=t,this.pendingTotal+=t.length,this.pending.length>=this._delta8){var n=(t=this.pending).length%this._delta8;this.pending=t.slice(t.length-n,t.length),0===this.pending.length&&(this.pending=null),t=K.join32(t,0,t.length-n,this.endian);for(var r=0;r<t.length;r+=this._delta32)this._update(t,r,r+this._delta32)}return this},U.prototype.digest=function(t){return this.update(this._pad()),o(null===this.pending),this._digest(t)},U.prototype._pad=function(){var t=this.pendingTotal,e=this._delta8,n=e-(t+this.padLength)%e,r=new Array(n+this.padLength);r[0]=128;for(var i=1;i<n;i++)r[i]=0;if(t<<=3,"big"===this.endian){for(var o=8;o<this.padLength;o++)r[i++]=0;r[i++]=0,r[i++]=0,r[i++]=0,r[i++]=0,r[i++]=t>>>24&255,r[i++]=t>>>16&255,r[i++]=t>>>8&255,r[i++]=255&t}else for(r[i++]=255&t,r[i++]=t>>>8&255,r[i++]=t>>>16&255,r[i++]=t>>>24&255,r[i++]=0,r[i++]=0,r[i++]=0,r[i++]=0,o=8;o<this.padLength;o++)r[i++]=0;return r};var I={BlockHash:F},W=K.rotr32;function G(t,e,n){return t&e^~t&n}function Z(t,e,n){return t&e^t&n^e&n}function Q(t,e,n){return t^e^n}var V={ft_1:function(t,e,n,r){return 0===t?G(e,n,r):1===t||3===t?Q(e,n,r):2===t?Z(e,n,r):void 0},ch32:G,maj32:Z,p32:Q,s0_256:function(t){return W(t,2)^W(t,13)^W(t,22)},s1_256:function(t){return W(t,6)^W(t,11)^W(t,25)},g0_256:function(t){return W(t,7)^W(t,18)^t>>>3},g1_256:function(t){return W(t,17)^W(t,19)^t>>>10}},X=K.sum32,Y=K.sum32_4,tt=K.sum32_5,et=V.ch32,nt=V.maj32,rt=V.s0_256,it=V.s1_256,ot=V.g0_256,ut=V.g1_256,st=I.BlockHash,at=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];function ct(){if(!(this instanceof ct))return new ct;st.call(this),this.h=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],this.k=at,this.W=new Array(64)}K.inherits(ct,st);var ht=ct;ct.blockSize=512,ct.outSize=256,ct.hmacStrength=192,ct.padLength=64,ct.prototype._update=function(t,e){for(var n=this.W,r=0;r<16;r++)n[r]=t[e+r];for(;r<n.length;r++)n[r]=Y(ut(n[r-2]),n[r-7],ot(n[r-15]),n[r-16]);var i=this.h[0],u=this.h[1],s=this.h[2],a=this.h[3],c=this.h[4],h=this.h[5],f=this.h[6],l=this.h[7];for(o(this.k.length===n.length),r=0;r<n.length;r++){var p=tt(l,it(c),et(c,h,f),this.k[r],n[r]),g=X(rt(i),nt(i,u,s));l=f,f=h,h=c,c=X(a,p),a=s,s=u,u=i,i=X(p,g)}this.h[0]=X(this.h[0],i),this.h[1]=X(this.h[1],u),this.h[2]=X(this.h[2],s),this.h[3]=X(this.h[3],a),this.h[4]=X(this.h[4],c),this.h[5]=X(this.h[5],h),this.h[6]=X(this.h[6],f),this.h[7]=X(this.h[7],l)},ct.prototype._digest=function(t){return"hex"===t?K.toHex32(this.h,"big"):K.split32(this.h,"big")};var ft=null;t.creatMiniAuth=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp",codeKey:"js_code"},e=t.appid,r=t.env,i=t.url,o=t.appKey,u=t.appCode,s=t.headers,a=t.codeKey;if(ft)return ft;var c={url:i,method:"POST",headers:s};return(ft=n.miniAuth.create({appid:e,env:r,tokenReqConfig:c})).use("token",(function(t,e){var n=t.tokenReqData.jsCode;n&&("undefined"!=typeof wx&&wx&&(t.tokenReqData={js_code:n},a&&(t.tokenReqData[a]=n)),"undefined"!=typeof my&&my&&(t.tokenReqData={auth_code:n}),!c.headers&&(c.headers={}),c.headers["Authorization-AppKey"]=o,c.headers["Authorization-Sign"]=ht().update("".concat(o).concat(JSON.stringify(t.tokenReqData)).concat(u)).digest("hex"),ft.setTokenReqConfig("headers",c.headers)),e()})),ft.use("afterToken",(function(t,e){var n=t.tokenResData.data,r=n.data,i=void 0===r?{}:r,o=n.retcode,u=n.msg,s=n.code;if(200===o||200===s)return t.tokenResData=i,e();var a={},c=5e4,h="UNKOWN";try{a=t.tokenResData.headers,c=t.tokenResData.status,h=u||t.tokenResData.data}catch(t){console.error(t)}return e({headers:a,status:c,retcode:o||s,msg:h,data:i})})),ft.setTokenExpires(36e5),ft},t.getToken=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return new i.default((function(e,n){!function r(i){ft.getToken(t).then((function(t){e(t)})).catch((function(t){5001===t.errCode||5002===t.errCode?i>=3?n(t):setTimeout((function(){r(i+1)}),2e3):n(t)}))}(0)}))},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=mini-auth-v1.common.js.map
